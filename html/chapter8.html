<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>Chapter 8｜车控 ToolCall 设计 (Vehicle Control Tools)</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">车舱场景语音实时对话机器人设计文档（Realtime + Agents SDK）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 1｜范围与需求（Scope & Requirements）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 2｜用户体验与对话交互 (UX & Conversation Design)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 3｜系统总体架构 (System Architecture)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 4｜Realtime 会话层设计 (Realtime Session Design)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 5｜Agents SDK 编排与多代理设计（Orchestration）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 6｜RAG 检索与知识系统设计（RAG & Knowledge System）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 7｜多模态感知输入设计 (Multimodal Perception Input)</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 8｜车控 ToolCall 设计 (Vehicle Control Tools)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 9｜GUI Agent：车载 App 自动化（点餐/购物/预约）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 10｜安全、隐私与合规 (Safety, Privacy & Compliance)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 11｜性能、实时性与降级策略 (Performance, Latency & Fallback)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 12｜可观测性、评测与持续迭代 (Observability, Evals & Iteration)</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 13｜部署与运维（Deployment & Operations）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 14｜测试计划与验收标准（Test & Acceptance）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Chapter 15｜附录（Appendix）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="chapter-8-toolcall-vehicle-control-tools">Chapter 8｜车控 ToolCall 设计 (Vehicle Control Tools)</h1>
<h2 id="1">1. 开篇段落</h2>
<p>本章聚焦于语音助手与物理车辆硬件交互的核心机制——<strong>车控工具调用（Vehicle Control ToolCall）</strong>。在 OpenAI Realtime API 和 Agents SDK 的架构下，大模型不仅仅是对话者，更是车辆的“执行中枢”。</p>
<p>车控系统的设计难度在于其连接了两个截然不同的世界：一个是<strong>概率性、模糊语义</strong>的 LLM 世界，另一个是<strong>确定性、硬实时、人命关天</strong>的嵌入式工程世界。</p>
<p><strong>学习目标</strong>：</p>
<ol>
<li><strong>全景架构</strong>：掌握从 LLM 意图到 CAN/SOA 信号的完整转换链路。</li>
<li><strong>防御性设计</strong>：学习如何通过“车控网关”构建鉴权（AuthZ）参数清洗（Sanitization）和安全门禁（Safety Gate）。</li>
<li><strong>模糊语义映射</strong>：如何处理“开一点窗”、“调得凉快点”等相对指令与硬件绝对参数之间的转换。</li>
<li><strong>状态一致性</strong>：理解乐观更新、最终一致性在车载交互中的应用，以及如何处理硬件故障导致的回滚。</li>
</ol>
<hr />
<h2 id="2">2. 核心设计论述</h2>
<h3 id="21-layered-architecture">2.1 车控工具的分层架构 (Layered Architecture)</h3>
<p>为了解耦模型与硬件，我们采用经典的<strong>三层漏斗模型</strong>设计 ToolCall。</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">Voice</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="s">&quot;我有点热&quot;</span>
<span class="w">      </span><span class="o">|</span>
<span class="w">      </span><span class="n">v</span>
<span class="p">[</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="w"> </span><span class="n">Intent</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Semantic</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">LLM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Agent</span><span class="p">)</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">识别意图</span><span class="o">:</span><span class="w"> </span><span class="n">AdjustClimate</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">提取参数</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;direction&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;cooler&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;magnitude&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;small&quot;</span><span class="p">}</span>
<span class="w">      </span><span class="o">|</span>
<span class="w">      </span><span class="n">v</span>
<span class="p">[</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="w"> </span><span class="n">Vehicle</span><span class="w"> </span><span class="n">Control</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="p">(</span><span class="n">VCG</span><span class="p">)</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">Middleware</span><span class="p">)</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">语义映射</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;cooler&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">current</span><span class="p">(</span><span class="mi">24</span><span class="err">°</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="mi">23</span><span class="err">°</span><span class="n">C</span><span class="p">)</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">安全校验</span><span class="o">:</span><span class="w"> </span><span class="n">检查车辆电源状态</span><span class="err">、</span><span class="n">检查儿童锁</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">权限裁决</span><span class="o">:</span><span class="w"> </span><span class="n">副驾是否有权调整全车温度</span><span class="err">？</span>
<span class="w">      </span><span class="o">|</span>
<span class="w">      </span><span class="n">v</span>
<span class="p">[</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">3</span><span class="o">:</span><span class="w"> </span><span class="n">Vehicle</span><span class="w"> </span><span class="n">Hardware</span><span class="w"> </span><span class="n">Abstraction</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">HAL</span><span class="p">)</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">Embedded</span><span class="p">)</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">信号转换</span><span class="o">:</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="mi">23</span><span class="err">°</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">CAN</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="mh">0x123</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="mh">0x17</span>
<span class="w">   </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">硬件执行</span><span class="o">:</span><span class="w"> </span><span class="n">发送至空调控制器</span><span class="w"> </span><span class="p">(</span><span class="n">HVAC</span><span class="w"> </span><span class="n">ECU</span><span class="p">)</span>
</code></pre></div>

<h3 id="22-granularity-taxonomy">2.2 工具目录设计与粒度控制 (Granularity &amp; Taxonomy)</h3>
<p>工具定义的粒度直接决定了 LLM 的理解准确率和令牌消耗。我们推荐<strong>“面向意图”</strong>而非<strong>“面向寄存器”</strong>的定义方式。</p>
<h4 id="221">2.2.1 推荐的工具定义模式</h4>
<ol>
<li>
<p><strong>聚合型工具 (Aggregated Tools)</strong></p>
<ul>
<li><em>Bad:</em> <code>set_fan_speed(level)</code>, <code>set_ac_mode(on/off)</code>, <code>set_temp(val)</code> 分散定义。</li>
<li><em>Good:</em> <code>adjust_climate(temperature, fan_speed, ac_mode, zone)</code>。</li>
<li><em>理由:</em> 用户常说“把空调开到24度，风大点”。聚合工具允许一次 ToolCall 完成多个寄存器修改，减少 Realtime API 的来回交互（Turn-taking）延迟。</li>
</ul>
</li>
<li>
<p><strong>场景化工具 (Scenario Tools)</strong></p>
<ul>
<li>定义一键直达的高级工具，对应车辆的“模式”。</li>
<li><code>enable_nap_mode()</code>: 同时执行（座椅躺平 + 车窗关闭 + 播放白噪音 + 闹钟设置）。</li>
<li><code>enable_baby_mode()</code>: 同时执行（音量限制 + 后排车窗锁止 + 空调柔风）。</li>
<li><em>Rule-of-Thumb:</em> 如果一个操作序列在车机屏幕上有一个专门的“一键启动”按钮，它就应该是一个独立的 Tool。</li>
</ul>
</li>
</ol>
<h4 id="222-expanded">2.2.2 风险分级矩阵 (Expanded)</h4>
<p>| 等级 | 标识 | 定义 | 典型功能 | 交互/鉴权策略 |</p>
<table>
<thead>
<tr>
<th style="text-align: left;">等级</th>
<th style="text-align: left;">标识</th>
<th style="text-align: left;">定义</th>
<th style="text-align: left;">典型功能</th>
<th style="text-align: left;">交互/鉴权策略</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>L0</strong></td>
<td style="text-align: left;"><code>INFO</code></td>
<td style="text-align: left;">只读，无物理动作</td>
<td style="text-align: left;">查续航、胎压、说明书</td>
<td style="text-align: left;">直接返回数据，无鉴权</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L1</strong></td>
<td style="text-align: left;"><code>COMFORT</code></td>
<td style="text-align: left;">可逆，低干扰</td>
<td style="text-align: left;">音乐、氛围灯、香氛</td>
<td style="text-align: left;">隐式确认（"好的"），全员可用</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L2</strong></td>
<td style="text-align: left;"><code>PHYSICAL</code></td>
<td style="text-align: left;">物理动作，低风险</td>
<td style="text-align: left;">座椅加热、空调风向</td>
<td style="text-align: left;">需检查能源状态，建议区分座次权限</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L3</strong></td>
<td style="text-align: left;"><code>CAUTION</code></td>
<td style="text-align: left;">物理动作，环境敏感</td>
<td style="text-align: left;">车窗、天窗、遮阳帘</td>
<td style="text-align: left;"><strong>环境校验</strong>（雨天/高速），失败需解释</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L4</strong></td>
<td style="text-align: left;"><code>CRITICAL</code></td>
<td style="text-align: left;">涉及行驶安全</td>
<td style="text-align: left;">后备、车门锁、大灯</td>
<td style="text-align: left;"><strong>强制二次确认</strong> + <strong>零车速门禁</strong> + 仅主驾</td>
</tr>
<tr>
<td style="text-align: left;"><strong>L5</strong></td>
<td style="text-align: left;"><code>BLOCKED</code></td>
<td style="text-align: left;">法律/安全禁止</td>
<td style="text-align: left;">油门、转向、换挡</td>
<td style="text-align: left;">不暴露给 LLM，物理层隔离</td>
</tr>
</tbody>
</table>
<h3 id="23-vcg">2.3 车控网关 (VCG) 的核心逻辑</h3>
<p>VCG 是本系统的核心守门员，它运行在车机的高算力芯片（如 Qualcomm 8155/8295）的 Android/QNX 层。</p>
<h4 id="231-shadow-state">2.3.1 影子状态 (Shadow State) 与参数补全</h4>
<p>LLM 说明的指令往往是不完整的（Partial）。VCG 必须维护一份车辆状态的<strong>缓存副本（Shadow State）</strong>。</p>
<ul>
<li><strong>场景</strong>: 用户说“把副驾窗户也关上”。</li>
<li><strong>Context</strong>: 上一轮对话刚关了主驾窗户。</li>
<li><strong>逻辑</strong>:<ol>
<li>LLM 输出: <code>control_window(seat="passenger", action="close")</code>。</li>
<li>VCG 读取 Shadow State: 发现副驾窗户当前位置 <code>pos = 50%</code>。</li>
<li>VCG 发现指令缺失目标位置，默认 <code>action="close"</code> 意味着 <code>target_pos = 0%</code>。</li>
<li>如果 Shadow State 显示副驾窗户已经是 <code>0%</code>，VCG 直接拦截并返“已关闭”，不发送 CAN 信号（节省总线带宽）。</li>
</ol>
</li>
</ul>
<h4 id="232-fuzzy-semantic-mapper">2.3.2 模糊语义映射 (Fuzzy Semantic Mapper)</h4>
<p>LLM 擅长处理自然语言，但不擅长处理车企特定的物理量化标准。VCG 需负责“翻译”。</p>
<ul>
<li><strong>相对量处理</strong>:<ul>
<li>指令: <code>adjust_temp(delta="hotter")</code></li>
<li>映射: <code>Target = Current_Temp + Step_Size (e.g., 1.0°C)</code></li>
<li>边界: <code>Target = min(Target, Max_Limit)</code></li>
</ul>
</li>
<li><strong>程度词处理</strong>:<ul>
<li>指令: <code>open_window(extent="a little bit")</code></li>
<li>映射: <code>Target = Current_Pos + 10%</code> (配置项: <code>define_little_bit = 10%</code>)</li>
<li>指令: <code>open_window(extent="halfway")</code></li>
<li>映射: <code>Target = 50%</code></li>
</ul>
</li>
</ul>
<h3 id="24-safety-authorization">2.4 安全策略与权限矩阵 (Safety &amp; Authorization)</h3>
<p>安全是车载系统的底线。我们采用<strong>拦截器模式 (Interceptor Pattern)</strong>。</p>
<h4 id="241">2.4.1 动态权限检查伪逻辑</h4>
<div class="codehilite"><pre><span></span><code>function authorize_action(user_role, vehicle_state, tool_name, params):
    # 1. 全局互斥锁 (e.g. 正在OTA升级中，正在紧急呼叫中)
    if GlobalLock.is_locked(): return DENY(&quot;系统占用中&quot;)

    # 2. 身份鉴权
    if user_role == &quot;GUEST&quot; and tool_name in [&quot;open_trunk&quot;, &quot;user_profile&quot;]:
        return DENY(&quot;访客模式无权操作&quot;)

    # 3. 驾驶状态门禁
    if vehicle_state.speed &gt; 0:
        if tool_name in [&quot;open_trunk&quot;, &quot;video_playback&quot;, &quot;pairing_bluetooth&quot;]:
            return DENY(&quot;行驶中禁止操作&quot;)
        if tool_name == &quot;open_sunroof&quot; and vehicle_state.speed &gt; 100:
            return DENY(&quot;车速过快，禁止开天窗&quot;)

    # 4. 环境感知互斥
    if tool_name == &quot;open_window&quot; and vehicle_state.rain_sensor == ON:
        return CONFIRM_REQUIRED(&quot;正在下雨，确定要开窗吗？&quot;)

    return ALLOW
</code></pre></div>

<h4 id="242">2.4.2 声区定向与资源绑定</h4>
<p>利用麦克风阵列的<strong>声源定位 (DOA)</strong>，将语音指令绑定到特定座位。</p>
<ul>
<li>用户（后左位置）：“打开座椅加热”。</li>
<li>Agent 接收到的 ToolCall 参数应自动注入：<code>seat_id="rear_left"</code>。</li>
<li><em>Gotcha:</em> 如果 LLM 错误地输出了 <code>seat_id="driver"</code>，VCG 应基于 DOA 信号进行二次校验或纠正。</li>
</ul>
<h3 id="25">2.5 反馈机制与延迟管理</h3>
<p>车控动作的执行时间差异巨大（毫秒级到秒级）。</p>
<h4 id="251">2.5.1 响应策略分类</h4>
<ol>
<li><strong>即发即弃 (Fire-and-Forget)</strong>: 用于无副作用、极快的操作。<ul>
<li><em>例:</em> “切歌”。</li>
<li><em>表现:</em> 语音回复“好的”与此同时发送信号。</li>
</ul>
</li>
<li><strong>乐观响应 (Optimistic Response)</strong>: 假设大概率成功。<ul>
<li><em>例:</em> “调高温度”。</li>
<li><em>表现:</em> 立即回复“已调高”，如果 2秒后 ECU 报错，再异步播报“抱歉，空调刚才响应超时”。</li>
</ul>
</li>
<li><strong>事务性响应 (Transactional Wait)</strong>: 必须等待物理确认。<ul>
<li><em>例:</em> “查询胎压”。</li>
<li><em>表现:</em> <ul>
<li>LLM: 调用工具 <code>get_tire_pressure()</code>。</li>
<li>(Silence / Filler sound "Hmm...") -&gt; 等待 500ms 信号返回。</li>
<li>LLM: 拿到结果后生成回复。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="252-long-tail-latency">2.5.2 处理长延迟 (Long-tail Latency)</h4>
<p>对于如“打开敞篷这种耗时 10秒+ 的操作：</p>
<ol>
<li><strong>阶段 1</strong>: 立即回复“正在打开敞篷...”。</li>
<li><strong>阶段 2</strong>: 保持静默，或播放机械音效。</li>
<li><strong>阶段 3</strong>: (通过 Agents SDK 的异步事件) 动作完成后，主动推送一条“敞篷已打开”。</li>
</ol>
<hr />
<h2 id="3">3. 本章小结</h2>
<ul>
<li><strong>网关模式 (Gateway Pattern)</strong>: VCG 是连接 AI 概率世界与工程确定性世界的桥梁，负责清洗、映射和鉴权。</li>
<li><strong>安全分级</strong>: 必须建立严格的 L0-L5 风险分级，不同等级对应不同的门禁策略（隐式/显式/禁止）。</li>
<li><strong>状态驱动</strong>: 工具参数应尽量使用“目标状态”（Set Target）而非“动作差值”（Delta），以确保幂等性。</li>
<li><strong>环境感知</strong>: 车控不仅仅是听懂指令，还要结合车速、雨量、座椅占用等传感器数据做决策。</li>
</ul>
<hr />
<h2 id="4">4. 练习题</h2>
<h3 id="_1">基础题</h3>
<p><strong>Q1. 什么是“幽灵操作” (Ghost Operation)？在车控场景中如何通过设计避免它？</strong></p>
<details>
<summary>点击展开答案提</summary>
<p><strong>Hint</strong>: 考虑 VAD（语音活动检测）误触发或模型幻觉。
<br>
<strong>Answer</strong>:
<strong>幽灵操作</strong>指用户未发指令或仅是在闲聊，系统却误识别为指令并执行了物理动作。
<br>
<strong>避免设计</strong>:</p>
<ol>
<li><strong>唤醒词依赖</strong>: 高风险操作（L3+）必须在带有唤醒词的对话中，ec 降低免唤醒的误触发率。</li>
<li><strong>二次确认</strong>: 对于敏感操作（开窗/开后备箱），如果置信度低于 0.9，强制反问“您是想打开后备箱吗？”。</li>
<li><strong>可视化反馈</strong>: 执行前在中控屏弹窗倒计时（Toast），允许用户点击“撤销”。</li>
</ol>
</details>
<p><strong>Q2. 为什么建议使用 <code>adjust_climate(...)</code> 这样一个大工具，而不是拆分成 <code>set_temp</code>, <code>set_fan</code> 等多个小工具？</strong></p>
<details>
<summary>点击展开答案提示</summary>
<p><strong>Hint</strong>: 关注 LLM 的推理成本和 Realtime API 的往返迟。
<br>
<strong>Answer</strong>:</p>
<ol>
<li><strong>减少延迟</strong>: 用户常在以一句话中包含多个指令（“太热了，风大点”）。如果拆分，模型可能需要生成两个独立的 ToolCall，甚至分两轮对话完成，增加等待时间。</li>
<li><strong>关联逻辑</strong>: 空调各参数是联动的。例如“最大制冷模式”可能意味着同时调整温度最低、风量最大、内循环开启。一个聚合工具更容易在代码层处理这种组合逻辑。</li>
<li><strong>Token 节省</strong>: 减少工具列表定义的长度（Schema Size），降低 Input Token 消耗。</li>
</ol>
</details>
<p><strong>Q3. 在设计“座椅加热”工具时，如何处理“主驾”和“副驾”的区分？</strong></p>
<details>
<summary>点击展开答案提示</summary>
<p><strong>Hint</strong>: 显式参数 vs. 隐式上下文。
<br>
<strong>Answer</strong>:
工具定义中应包含 <code>seat_id</code> 参数 (enum: <code>driver, passenger, rear_left, rear_right</code>)。</p>
<ol>
<li><strong>显式指定</strong>: 用户说“打开副驾座椅加热”，LLM 提取 <code>seat_id="passenger"</code>。</li>
<li><strong>隐式推断</strong>: 用户说“我有点冷”，LLM 输出 <code>seat_id="current_speaker"</code> (或留空)。</li>
<li><strong>网关解析</strong>: VCG 接收到 "current_speaker" 后，查询音频模块的声源定位 (DOA) 结果，将其替换为实际的物理座位 ID。</li>
</ol>
</details>
<h3 id="_2">挑战题</h3>
<p><strong>Q4. (架构设计) 设计一个“自动泊车”的语音交互流程。考虑到这是一个高风险、长耗时的过程，请详细描述从用户发出指令到泊车结束的每一个步骤，包括屏幕交互和异常处理。</strong></p>
<details>
<summary>点击展开答案提示</summary>
<p><strong>Hint</strong>: 涉及 ToolCall、GUI 联动、持续监控、用户接管。
<br>
<strong>Answer</strong>:</p>
<ol>
<li><strong>唤醒与意图</strong>: 用户“帮我泊车”。</li>
<li><strong>环境检查 (Pre-check)</strong>: VCG 检查车速 &lt; 10km/h，挡位 D/R，且感知系统已识别到车位。
   - <em>异常分支</em>: 未识别车位 -&gt; 回复“未检测到可用车位，请继续向前行驶”。</li>
<li><strong>GUI 确认 (Selection)</strong>: 屏幕高亮显示识别到的车位 (A, B, C)。
   - Bot: “找到 3 个车位，要停在左边这个吗？”</li>
<li><strong>工具调用</strong>: 用户“对，就这个”。LLM 调用 <code>start_auto_parking(slot_id="A")</code>。</li>
<li><strong>安全握手 (Handshake)</strong>:
   - 系统不直接行动，而是弹窗并语音提示：“请松开刹车，双手离开方向盘，随时准备接管。”
   - 用户确认（可能是语音“好了”，或点击屏幕“开始”）。</li>
<li><strong>执行与监视 (Execution)</strong>:
   - 车辆开始运动。
   - 语音系统进入“实时播报模式”：“正在倒车... 正在避让行人...”。</li>
<li><strong>完成</strong>: 动作结束，挂 P 挡。Bot: “泊车已完成。”</li>
</ol>
</details>
<p><strong>Q5. (模糊逻辑) 用户说“把窗户开个缝”。请编写一段伪代码，说明 VCG 如何将其转化为具体的 CAN 信号。假设车窗全关是 0%，全开是 100%。</strong></p>
<details>
<summary>点击展开答案提示</summary>
<p><strong>Hint</strong>: 需要读取当前状态，并处理边界情况。
<br>
<strong>Answer</strong>:</p>
<pre><code>
function handle_open_crack(seat_id):
    # 1. 定义 "缝" 的大小
    const CRACK_SIZE = 15% 

    # 2. 获取当前位置 (Shadow State)
    current_pos = vehicle.windows[seat_id].position

    # 3. 计算目标位置
    # 如果已经在开着，就在当前基础上再开一点？还是保持最小通风位置？
    # 策略：如果当前几乎全关 (&lt;5%)，设为 15%。
    # 如果当前已经开很大了 (&gt;20%)，"开个缝"可能意味着"关小到只剩个缝"。

    if current_pos &lt; 5:
        target_pos = 15
    elif current_pos &gt; 20:
        target_pos = 15  # 意图理解为：关小到缝
    else:
        # 已经在缝的状态，可能用户没看清，保持不变或微调
        target_pos = 15 
        return Response("窗户已经开了一条缝了")

    # 4. 下发指令
    vehicle.hardware.set_window(seat_id, target_pos)
    return Response("已打开通风模式")
</code></pre>
</details>
<p><strong>Q6. (回滚策略) LLM 调用了 <code>set_seat_heat(level=3)</code>，但底层硬件返回 <code>ERROR_OVERHEAT_PROTECTION</code> (过热保护中)。此时 Realtime Session 应当如何处理？</strong></p>
<details>
<summary>点击展开答案提示</summary>
<p><strong>Hint</strong>: Tool Output 需要包含错误信息，Agent 需要理解错误并转述。
<br>
<strong>Answer</strong>:</p>
<ol>
<li>
<p><strong>VCG 层</strong>: 捕获硬件错误码，不抛出异常导致程序崩溃，而是封装为结构化结果：
   <code>{"status": "failed", "error_code": "E_OVERHEAT", "user_msg": "座椅温度过高，已触发保护"}</code></p>
</li>
<li>
<p><strong>Tool Output 注入</strong>: 将上述 JSON 推送回 Realtime API 的会话上下文。</p>
</li>
<li><strong>Agent 推理</strong>: 模型看到 status=failed，不再回复“好的，已开启”，而是根据 <code>user_msg</code> 生回复。</li>
<li><strong>TTS 输出</strong>: “抱歉，检测到座椅温度过高，系统已触发过热保护，暂时无法开启加热。”</li>
</ol>
</details>
<hr />
<h2 id="5-gotchas">5. 常见陷阱与错误 (Gotchas)</h2>
<h3 id="51-privilege-escalation">5.1 权限穿透 (Privilege Escalation)</h3>
<ul>
<li><strong>错误</strong>: 简单地将车控 API 暴露给 Agent，没有检查<strong>谁</strong>在说话。</li>
<li><strong>后果</strong>: 后排顽皮的儿童喊“打开后备箱”，车在高速上行驶时后备箱弹开。</li>
<li><strong>对策</strong>: 所有的 Critical 工具必须校验 <code>Speaker_Role</code> 和 <code>Vehicle_Speed</code>。</li>
</ul>
<h3 id="52-state-flapping">5.2 状态震荡 (State Flapping)</h3>
<ul>
<li><strong>错误</strong>: 用户说“温度调高”，Gateway 读取当前是 20度，设为 21度。用户紧接着（1秒内）又说“再高点”。</li>
<li><strong>问题</strong>: 由于 CAN 总线延迟，第二次读取时“当前温度”可能还没更新成 21度，依然读到 20度，结果还是设为 21度。用户感觉系统没反应。</li>
<li><strong>对策</strong>: <strong>乐观锁定</strong>或<strong>本地预测</strong>。Gateway 在发送指令后，应立即更新本地的 Shadow State 为 21度（即使硬件还没反馈），后续基于 21度计算。</li>
</ul>
<h3 id="53">5.3 忽略多模态冲突</h3>
<ul>
<li><strong>错误</strong>: 用户在看电影，突然想调空调。语音助手回复“好的！已为您调整！”声音巨大，打断了电影氛围。</li>
<li><strong>对策</strong>: 识别到 <code>Media_Status == Playing</code> 时，车控类指令应<strong>静默执行</strong>（不播放 TTS），或者仅以极短的提示音（"Ding"）作为反馈，并在屏幕上显示 Toast。</li>
</ul>
<h3 id="54">5.4 过于自信的“已执行”</h3>
<ul>
<li><strong>错误</strong>: 只要发送了信号就回复“已打开”。</li>
<li><strong>后果</strong>: 假如电机故障，窗户没动，用户会觉得系统在撒谎。</li>
<li><strong>对策</strong>: 对于容易感知失败的动作（如天窗），话术应留有余地，或者使用 Transactional 模式确认硬件状态变化后再回复。</li>
</ul>
<h3 id="55">5.5 误触发“全车控制”</h3>
<ul>
<li><strong>错误</strong>: 用户只想开自己的窗户，说“打开窗户”，结果四个窗户全开了。</li>
<li><strong>对策</strong>: 默认作用域（Scope）应最小化。如果未指定位置，优先操作当前说话人的位置（DOA），而不是全车。必须显式说“打开<strong>所有</strong>窗户”才执行全车操作。</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter7.html" class="nav-link prev">← Chapter 7｜多模态感知输入设计 (Multimodal Perception Input)</a><a href="chapter9.html" class="nav-link next">Chapter 9｜GUI Agent：车载 App 自动化（点餐/购物/预约） →</a></nav>
        </main>
    </div>
</body>
</html>